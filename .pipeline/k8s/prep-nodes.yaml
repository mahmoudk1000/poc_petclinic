---
apiVersion: v1
kind: ConfigMap
metadata:
  name: trusted-ca
  namespace: kube-system
data:
  cert.crt: |
    -----BEGIN CERTIFICATE-----
    MIIGSzCCBDOgAwIBAgIUF0N/CArf48c+U8/KNgZxQGwuSHYwDQYJKoZIhvcNAQEL
    BQAwgZQxCzAJBgNVBAYTAkVHMRMwEQYDVQQIDApBbGV4YW5kcmlhMRMwEQYDVQQH
    DApBbGV4YW5kcmlhMQ0wCwYDVQQKDARBdG9zMQ8wDQYDVQQLDAZEZXZPcHMxJTAj
    BgkqhkiG9w0BCQEWFm1haG1vdWRrMTAwMEBnbWFpbC5jb20xFDASBgNVBAMMCyou
    bGFiYmkubGFiMB4XDTI0MDkwODE2NDcwMVoXDTI1MDkwODE2NDcwMVowgZQxCzAJ
    BgNVBAYTAkVHMRMwEQYDVQQIDApBbGV4YW5kcmlhMRMwEQYDVQQHDApBbGV4YW5k
    cmlhMQ0wCwYDVQQKDARBdG9zMQ8wDQYDVQQLDAZEZXZPcHMxJTAjBgkqhkiG9w0B
    CQEWFm1haG1vdWRrMTAwMEBnbWFpbC5jb20xFDASBgNVBAMMCyoubGFiYmkubGFi
    MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAtABnR/OIQgEytFGqxq5/
    UrGkiN4OlfMnhzYfVoIz5xKnIlCf55Zn3/VqlbUlkrpcGABspYZ3gA7oHo5qUKMm
    r5fHypXj2NgQWhqV9hv4Wt3oTnLa+UUxHTgQKcelY+nPgW0Tr3PCm9vGHMjmUTxz
    DwFtjZYdjne7ukcPko7zZgW/U+prrZqwjyrmUsB8hmCF513/wU20nsoYgRoMNPr4
    o9m7Gvr+34yO9gGz2Q43SH+CTRM99BieWjHXDRlZYYassECxaZxhnfez52oXU2jO
    6ylu9KMDciJwnI7eDFD6EtHpT7ICi26lIdWE075066O08uLUUNOwQ2SS18vr39ul
    aRdJnPx61vzRCy6f3um18Rt9dPb9wjqmiUzNtd3TAHa1bf7VGaBNqqGpvytk9meA
    o7WJe5xsAbZrw2yY+Z3lT14+5gUtB0gum8K9zEuRuES1p/+B54XJ11F+d5H+CAR/
    9AvgI76JxJTXrEacBOofJT6PYHTBIfTyH5tEVzC5JOFX7vwOdeHufNtlym03VRLW
    1eLx/A594ZPqQf6IdHKL0Emo3u2johDwmTWcaKnXXhizQPJNyujvsAqLqCsEqGMz
    KBYATWEKsJa5Pl7xWTTyVfebIKpali8B5/72YPcrUaI7bhOPvqTPGBlwVv8FNhH8
    6MpM1TgerQFcliy3VGZ0kSECAwEAAaOBkjCBjzAJBgNVHRMEAjAAMAsGA1UdDwQE
    AwIFoDBWBgNVHREETzBNgglsYWJiaS5sYWKCCyoubGFiYmkubGFighFqZW5raW5z
    LmxhYmJpLmxhYoIPc29uYXIubGFiYmkubGFigg9uZXh1cy5sYWJiaS5sYWIwHQYD
    VR0OBBYEFKduLyQxPJ4GpYDlAC3271h2CUWmMA0GCSqGSIb3DQEBCwUAA4ICAQCO
    arZtfRVa2LbmzLFwE5GbVM2gkAqQpf1cAxnGhdUUW3eeVoPA6hTIFvFOWmWnkz2r
    f9DlolbBTe2ATH9AR1v+MZEOtSbHyHjhG6084JZhp/n0wHp/i9EohykDLb98FgDa
    eV9dmX32W+3vCojLb3gQSlBYnunK1Zz1HZJPwyScZDP+dItodST35lAbs7h7wi7Y
    UGWqzue8aPIljfzNKtqrzJ47Q7LtQeO0ATRfVwSVyj3I6NkVzwoaTJu8DyJzJl08
    owpZwx9JBzieyQoGQPGzoWXMX0I1KCWYGLqtMLA6aEOBaCkaIJXbJxJ7Mda7zUvN
    3AAeiPLXU69dlyVrXw9o8UXQwP0j+wUedWv63pGWgvLw1Y3FSWhG8fRQOjBsFFhU
    lAXJtATDM23bLkG829JAFwIJFFAAo94Wm0paLHrPG4hJFRyRALcV2b0CP43C/kRV
    pdbE94+X19joOsJLUssl6kN0tT+Sk0tSZz+laKeBD3b3XPpOESrQGOvRYrcawYLd
    v/vu3+vnI0NPQKh0YhvSm+DIr9ngXd418ulXK0PZKwVUlZRk+uL9BOUCfM+RrW24
    WcH04bM2+5gkbX30JUHm/EYJTwmjzjrOxwcVvbLgpvvjYVF+giC4f/440dH3VwVB
    vmGtp3x1MjFMS6mMmidiXUI8/3OhXsiuMTpsfy863Q==
    -----END CERTIFICATE-----
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: scripts
  namespace: kube-system
data:
  cert_install.sh: |
    echo "$TRUSTED_CERT" > /usr/local/share/ca-certificates/cert.crt &&
    echo "$TRUSTED_CERT" > /etc/ssl/certs/cert.crt &&
    update-ca-certificates &&
    systemctl restart containerd
  hosts.sh: |
    echo "52.166.234.158 registry.labbi.lab" >> /etc/hosts
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  namespace: kube-system
  name: nodes-injector
  labels:
    k8s-app: nodes-injector
spec:
  selector:
    matchLabels:
      k8s-app: nodes-injector
  template:
    metadata:
      labels:
        k8s-app: nodes-injector
    spec:
      hostPID: true
      hostNetwork: true
      initContainers:
        - name: cert-node
          command: [nsenter]
          args: [--mount=/proc/1/ns/mnt, --, sh, -c, $(CERT_SCRIPT)]
          image: debian
          env:
            - name: TRUSTED_CERT
              valueFrom:
                configMapKeyRef:
                  name: trusted-ca
                  key: cert.crt
            - name: CERT_SCRIPT
              valueFrom:
                configMapKeyRef:
                  name: scripts
                  key: cert_install.sh
          securityContext:
            privileged: true
        - name: host-node
          command: [nsenter]
          args: [--mount=/proc/1/ns/mnt, --, sh, -c, $(HOSTS_SCRIPT)]
          image: debian
          env:
            - name: HOSTS_SCRIPT
              valueFrom:
                configMapKeyRef:
                  name: scripts
                  key: hosts.sh
          securityContext:
            privileged: true
      containers:
        - name: wait
          image: k8s.gcr.io/pause:3.1
